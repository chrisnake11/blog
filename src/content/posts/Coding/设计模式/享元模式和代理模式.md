---
title: 享元模式和代理模式
published: 2025-09-05T11:14:12Z
description: '设计模式之享元模式和代理模式，使用游戏中贴图绘制的例子来说明。'
image: ''
tags: [享元模式, 代理模式]
category: '设计模式'
draft: false
---

# 享元模式

书接上回[工厂模式](./工厂模式.md)，我们继续介绍设计模式。

享元模式（Flyweight Pattern）是一种结构型设计模式，旨在通过共享对象来减少内存消耗，提高性能。

当多个对象需要使用同一份资源时，可以将这些资源抽象为一个享元对象，并通过引用计数等方式来管理这些共享资源。

## 适用场景

在2D游戏开发中，我们通常会使用大量的贴图(Sprite 精灵贴图)来绘制游戏场景和角色。而往往游戏中会出现很多重复的对象，这些对象往往使用相同的贴图资源。
如果每个对象都单独存储一份贴图资源，会导致内存消耗过大，影响游戏性能。

## 示例

有一个Sprite类表示游戏中的一个贴图对象。

```cpp
class Sprite{
public:
    vector<char> texture;

    // 在position上绘制贴图
    void draw(glm::vec3 position) {
        // 绘制贴图
        glDrawPixels(position, texture);
    }
};

class Bullet{
    glm::vec3 position;
    glm::vec3 direction;
    glm::vec3 velocity;
    std::shared_ptr<Sprite> sprite; // 使用共享的贴图资源

    // 通过共享的贴图资源来绘制子弹
    void draw() {
        sprite->draw(position);
    }
};
```

Bullet对象只需要传递当前的position，直接调用sprite的draw方法就可以将贴图绘制到指定位置。Bullet只需要更新position，而不需要关心贴图的绘制逻辑。

这种直接转发调用的方式也被称为**代理模式**。它与适配器模式不同，**适配器模式**是将一个接口转化为另一个接口实现接口兼容，而**代理模式**是直接转发调用。

# 代理模式

通过代理模式，我们可以将绘制贴图的接口和贴图资源本身分离开来。将Sprite设计为一个虚函数接口类负责绘制贴图，然后实现它们的具体类，每个类都只负责存储一种贴图资源，以及对应的绘制逻辑。

```cpp
// Sprite接口类负责绘制贴图
class Sprite{
public:
    virtual void draw(glm::vec3 position) = 0;
};

class BulletSprite: public Sprite{
public:
    vector<char> bulletTexture;

    void draw(glm::vec3 position) override {
        // 绘制子弹贴图
        glDrawPixels(position, bulletTexture);
    }
};

class GrenadeSprite: public Sprite{
public:
    vector<char> grenadeTexture;

    void draw(glm::vec3 position) override {
        // 绘制手雷贴图
        glDrawPixels(position, grenadeTexture);
    }
};

class Bullet{
    glm::vec3 position;
    glm::vec3 direction;
    glm::vec3 velocity;
    std::shared_ptr<Sprite> sprite; // 使用共享的贴图资源

    // 通过共享的贴图资源来绘制子弹
    void draw() {
        sprite->draw(position);
    }
};
```


# 参考资料

[让虚函数再次伟大！](https://github.com/parallel101/course/blob/master/slides/design/virtual.md)

[bilibili: 速通面向对象设计模式（1）：策略、工厂、迭代器、适配器、享元、代理](https://www.bilibili.com/video/BV1u1421i7GV?spm_id_from=333.788.videopod.sections&vd_source=caf7bc500eb03a267461b0af17a20763)