---
title: 观察者模式
published: 2025-09-05T19:53:42Z
description: '设计模式之观察者模式，当一个主体类内部存在多个组件类，实现多个组件类的内部通信。使用游戏中玩家上线通知其他玩家的例子来说明。'
image: 'https://cdn.jsdelivr.net/gh/chrisnake11/picgo@main/blog/观察者模式-2025-09-05-19-54-04.png'
tags: [观察者模式, 组件模式, 设计模式]
category: '设计模式'
draft: false
---

# 观察者模式

观察者模式（Observer Pattern）是一种设计模式，定义了一种一对多的依赖关系，使得当一个对象的状态发生改变时，所有依赖于它的对象都会得到通知并自动更新。

![观察者模式-2025-09-05-19-54-04](https://cdn.jsdelivr.net/gh/chrisnake11/picgo@main/blog/观察者模式-2025-09-05-19-54-04.png)


## 示例

```cpp
struct Message{
    virtual ~Message() = default;
};

struct OnlineMessage : public Message{
    std::string text;
};

struct Component{
    virtual void update(Game* game) = 0;
    virtual void handleMessage(Message* message) = 0;
    virtual ~Component() = default;
}

// 广播状态组件
struct BroadcastComponent : public Component{
    // 所有的消息都会被这个函数处理
    void handleMessage(Message* message) override{
        // 处理OnlineMessage
        if(auto onlineMessage = dynamic_cast<OnlineMessage*>(message)){
            std::cout << onlineMessage->text << std::endl;
        }
    }
}

struct Player : public Component{
    std::string name;
    void update(Game* game) override{
        // 玩家更新逻辑，比如上线
        OnlineMessage message;
        message.text = name + " is online";
        // 调用组件容器的函数，广播消息给所有组件
        game->send(&message);
    }

    void handleMessage(Message* message) override{
        // 处理OnlineMessage
        if(auto onlineMessage = dynamic_cast<OnlineMessage*>(message) && onlineMessage->text != name + " is online"){
            std::cout << onlineMessage->text << std::endl;
        }
    }
}

struct Game{
    vector<Component*> components;

    void add(Component* component){
        components.push_back(component);
    }

    // 更新所有组件
    void update(){
        for(auto component : components){
            component->update(this);
        }
    }

    // 广播消息给所有组件
    void send(Message* message){
        for(auto component : components){
            component->handleMessage(message);
        }
    }
};

int main(){
    Game game;
    Player player1;
    player1.name = "Alice";
    Player player2;
    player2.name = "Bob";
    BroadcastComponent broadcastComponent;

    game.add(&player1);
    game.add(&player2);
    game.add(&broadcastComponent);

    // 游戏更新，玩家上线
    game.update();

    return 0;
}
```