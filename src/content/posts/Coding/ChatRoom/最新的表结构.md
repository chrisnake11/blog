---
title: 最新的表结构
published: 2025-09-02T12:16:03Z
description: ''
image: ''
tags: []
category: ''
draft: false
---

# 最新的表结构

## 好友关系表

```sql
CREATE TABLE `friend_relationship` (
  `id` bigint UNSIGNED NOT NULL AUTO_INCREMENT,
  `user_id` bigint UNSIGNED NOT NULL,       -- 主体用户
  `friend_id` bigint UNSIGNED NOT NULL,     -- 好友用户
  `status` tinyint NOT NULL DEFAULT 0,      -- 0=正常, 1=已拉黑
  `remark` varchar(64) DEFAULT NULL,        -- 备注名
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uniq_friend` (`user_id`, `friend_id`),
  CONSTRAINT `fk_friend_user` FOREIGN KEY (`user_id`) REFERENCES `user_info`(`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_friend_friend` FOREIGN KEY (`friend_id`) REFERENCES `user_info`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

uniq_friend保证可以存在唯一的好友关系，避免重复数据。并且数据是单向的，当添加好友关系时，应当添加两份数据。

外键约束保证friend_id和user_id指向的用户必须存在于user_info表，当用户删除时，相应的好友关系也会删除。

好友申请表：
```sql
CREATE TABLE friend_requests (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    requester_id BIGINT NOT NULL,  -- 发起方
    receiver_id BIGINT NOT NULL,   -- 接收方
    status ENUM('pending','accepted','rejected') NOT NULL DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT fk_requester FOREIGN KEY (requester_id) REFERENCES user_info(id) ON DELETE CASCADE,
    CONSTRAINT fk_receiver FOREIGN KEY (receiver_id) REFERENCES user_info(id) ON DELETE CASCADE
);
```

用于记录好友申请的状态，避免重复申请，并且可以查询历史申请记录。

## 会话表

会话表：

```sql
CREATE TABLE `conversation` (
  `conversation_id` bigint UNSIGNED NOT NULL AUTO_INCREMENT,
  `type` tinyint NOT NULL,         -- 1=私聊，2=群聊
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `last_message_id` bigint UNSIGNED DEFAULT NULL, -- 最后一条消息
  PRIMARY KEY (`conversation_id`),
  INDEX `last_msg_idx`(`last_message_id`)
);
```

每个群聊或者好友间的对话，都会被初始化为一个会话项。会话项一般不会轻易删除，即使用户删除聊天记录仍然存在。

会话成员表：

```sql
CREATE TABLE `conversation_member` (
  `id` bigint UNSIGNED NOT NULL AUTO_INCREMENT,
  `conversation_id` bigint UNSIGNED NOT NULL,
  `user_id` bigint UNSIGNED NOT NULL,
  `role` tinyint DEFAULT 0,          -- 群聊时：0=成员，1=管理员，2=群主
  `unread_count` int UNSIGNED DEFAULT 0,
  `last_read_message_id` bigint UNSIGNED DEFAULT NULL, -- 最近读到哪条消息
  `join_time` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `conv_user_idx` (`conversation_id`,`user_id`),
  CONSTRAINT `conv_fk` FOREIGN KEY (`conversation_id`) REFERENCES `conversation`(`conversation_id`) ON DELETE CASCADE
);
```

管理会话对应的所有成员以及对应的角色。记录该角色上次读到的消息id以及未读的数量。这样就可以实现未读消息的统计。


消息表:

```sql
CREATE TABLE `message` (
  `message_id` bigint UNSIGNED NOT NULL AUTO_INCREMENT,
  `conversation_id` bigint UNSIGNED NOT NULL,
  `sender_id` bigint UNSIGNED NOT NULL,
  `content` text NOT NULL,
  `send_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `type` tinyint NOT NULL,           -- 1=文本，2=图片，3=文件，4=语音，5=视频
  PRIMARY KEY (`message_id`),
  INDEX `conv_idx`(`conversation_id`),
  CONSTRAINT `msg_conv_fk` FOREIGN KEY (`conversation_id`) REFERENCES `conversation`(`conversation_id`) ON DELETE CASCADE
);
```

存储单个会话中的所有消息。记录发送者的id以及发送的时间、内容、类型，并且通过conversation_id关联到对应的会话。

## 读取好友列表
+ 在`friend_relationship`表中，查询所有的好友关系，备注名，同时获取好友的基本信息（头像，nickname，个性签名）

## 读取会话列表
+ 在`conversation_member`表中，查询当前用户的所有会话id
+ 通过会话id，在`conversation`表中，获取会话的最后一条消息id
+ 通过最后一条消息id，在`message`表中，获取最后一条消息的内容、发送时间

## 读取单个会话
+ 通过会话id，在`conversation_member`表中，获取当前用户的未读消息数量，并且将未读消息数量清零
+ 通过会话id，在`message`表中，分页获取消息列表

## 发送消息
+ 插入一条消息到`message`表中
+ 更新`conversation`表中的最后一条消息id
+ 更新`conversation_member`表中，除发送者外的所有成员的未读消息数量+1

## 申请好友
+ 在`friend_requests`表中，插入一条记录，状态为pending。
+ 当接收方同意时，更新状态为accepted，并且在`friend_relationship`表中插入两条记录，表示双向好友关系。
+ 当接收方拒绝时，更新状态为rejected。
+ 当用户删除好友时，删除`friend_relationship`表中的两条记录。
+ 删除好友时，不删除`friend_requests`表中的记录，保留历史申请记录。
+ 删除用户时，级联删除`friend_relationship`和`friend_requests`表中的相关记录。